<!DOCTYPE html>
<html lang="en">
<head>
    <!-- 保持原有样式不变 -->
    <style>
        /* 原有样式保持不变 */
    </style>
</head>
<body>
    <!-- 保持HTML结构不变 -->

    <script>
        // 修复后的核心代码部分
        let currentDriver = '';
        const DRAFT_PREFIX = 'driving_draft_';
        let saveTimer = null;

        // 增强版自动保存（添加微信兼容处理）
        function autoSaveDraft() {
            if (!currentDriver) return;
            
            // 收集所有数据（包含空值处理）
            const draftData = {
                date: document.getElementById('date').value || '',
                plate: document.getElementById('plate').value || '',
                name: document.getElementById('name').value || '',
                startTime: document.getElementById('start-time').value || '',
                startKm: document.getElementById('start-km').value || '',
                endTime: document.getElementById('end-time').value || '',
                endKm: document.getElementById('end-km').value || '',
                fuel: document.getElementById('fuel').value || '0',
                parking: document.getElementById('parking').value || '0',
                taxi: document.getElementById('taxi').value || '0'
            };

            try {
                // 添加微信浏览器存储异常处理
                localStorage.setItem(`${DRAFT_PREFIX}${currentDriver}`, JSON.stringify(draftData));
                console.log('自动保存成功:', draftData);
            } catch (e) {
                console.error('存储失败:', e);
                alert('自动保存失败，请检查浏览器存储权限');
            }
        }

        // 优化后的加载逻辑
        function loadDraft() {
            if (!currentDriver) return;
            
            try {
                const draft = localStorage.getItem(`${DRAFT_PREFIX}${currentDriver}`);
                if (!draft) return;

                const data = JSON.parse(draft);
                
                // 智能填充逻辑（仅填充空字段）
                const fields = [
                    ['date', data.date],
                    ['plate', data.plate],
                    ['name', data.name],
                    ['start-time', data.startTime],
                    ['start-km', data.startKm],
                    ['end-time', data.endTime],
                    ['end-km', data.endKm],
                    ['fuel', data.fuel],
                    ['parking', data.parking],
                    ['taxi', data.taxi]
                ];

                fields.forEach(([id, value]) => {
                    const el = document.getElementById(id);
                    if (el && !el.value) el.value = value;
                });

                console.log('草稿加载成功:', data);
            } catch (e) {
                console.error('加载失败:', e);
            }
        }

        // 增强的事件监听（兼容微信输入法）
        function setupEventListeners() {
            // 司机切换监听
            document.getElementById('driver').addEventListener('change', function() {
                if (currentDriver) autoSaveDraft();
                currentDriver = this.value;
                loadDraft();
                syncFormData();
            });

            // 车牌输入特殊处理
            document.getElementById('plate').addEventListener('change', function() {
                if (this.value === 'Other') {
                    const manualPlate = prompt('输入车牌号:');
                    if (manualPlate) {
                        const exists = Array.from(this.options).some(opt => opt.value === manualPlate);
                        if (!exists) {
                            const newOption = new Option(manualPlate, manualPlate);
                            this.add(newOption);
                        }
                        this.value = manualPlate;
                    }
                }
                autoSaveDraft();
            });

            // 通用输入监听（添加防抖）
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    if (saveTimer) clearTimeout(saveTimer);
                    saveTimer = setTimeout(() => {
                        if (currentDriver) autoSaveDraft();
                        syncFormData();
                    }, 800);
                });
                
                // 添加blur事件确保保存
                input.addEventListener('blur', () => {
                    if (currentDriver) autoSaveDraft();
                });
            });
        }

        // 初始化（添加微信环境检测）
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化日期
            const dateInput = document.getElementById('date');
            if (!dateInput.value) {
                const now = new Date();
                dateInput.value = now.toISOString().split('T')[0];
            }

            // 初始化司机
            const driverSelect = document.getElementById('driver');
            driverSelect.addEventListener('change', syncFormData);
            currentDriver = driverSelect.value;
            
            // 微信环境特殊处理
            const isWeChat = /MicroMessenger/i.test(navigator.userAgent);
            if (isWeChat) {
                alert('微信用户提示：请确保已启用存储权限\n建议使用系统浏览器获得最佳体验');
            }

            setupEventListeners();
            loadDraft();
            syncFormData();
        });

        // 保持原有业务逻辑函数不变
        function calculateOvertime() { /* 保持不变 */ }
        function syncFormData() { /* 保持不变 */ }
        function generateAndShare() { /* 保持不变 */ }
        function buildDataString() { /* 保持不变 */ }
    </script>
</body>
</html>
